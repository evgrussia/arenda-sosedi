# Бизнес-процессы: Арендо-Соседи

> Описание ключевых бизнес-процессов платформы в нотации BPMN

---
**Документ:** BUSINESS-003
**Версия:** 1.0
**Дата:** 2025-02-05
**Автор:** Business-Analyst Agent
---

## Обзор процессов

| ID | Процесс | Участники | Критичность |
|----|---------|-----------|-------------|
| BP-001 | Регистрация пользователя | User, System | Высокая |
| BP-002 | Создание листинга | Owner, System | Высокая |
| BP-003 | Бронирование и оплата | Renter, System, YooKassa | Критическая |
| BP-004 | Подтверждение аренды | Owner, Renter, System | Критическая |
| BP-005 | Процесс аренды | Owner, Renter | Высокая |
| BP-006 | Завершение аренды | Owner, Renter, System | Критическая |
| BP-007 | Разрешение споров | Owner, Renter, Admin, System | Средняя |
| BP-008 | Выплата владельцу | System, YooKassa, Owner | Критическая |

---

## BP-001: Регистрация пользователя

### Диаграмма процесса

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        BP-001: РЕГИСТРАЦИЯ ПОЛЬЗОВАТЕЛЯ                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌─────────┐  │
│  │ START │───►│ Открывает│───►│ Валидация│───►│ Создание │───►│ Выбор   │  │
│  │       │    │ WebApp   │    │ initData │    │ профиля  │    │ ЖК      │  │
│  └───────┘    └──────────┘    └────┬─────┘    └──────────┘    └────┬────┘  │
│                                    │                               │        │
│                                    ▼ invalid                       ▼        │
│                               ┌─────────┐                    ┌─────────┐   │
│                               │ Ошибка  │                    │ Профиль │   │
│                               │ авториз.│                    │ готов   │   │
│                               └─────────┘                    └────┬────┘   │
│                                                                   │        │
│                                                                   ▼        │
│                                                              ┌─────────┐   │
│                                                              │   END   │   │
│                                                              └─────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Описание шагов

| Шаг | Действие | Исполнитель | Данные |
|-----|----------|-------------|--------|
| 1 | Открывает WebApp | User | - |
| 2 | Получает initData от Telegram | System | user_id, name, photo |
| 3 | Валидирует подпись | System | initData, bot_token |
| 4 | Создаёт профиль (если новый) | System | User record |
| 5 | Показывает экран выбора ЖК | System | Complex list |
| 6 | Выбирает ЖК | User | complex_id |
| 7 | Сохраняет привязку к ЖК | System | User.complex_id |
| 8 | Перенаправляет на главную | System | - |

### Бизнес-правила

| Правило | Описание |
|---------|----------|
| BR-001.1 | Авторизация только через Telegram WebApp |
| BR-001.2 | initData должен быть валиден (подпись) |
| BR-001.3 | Выбор ЖК обязателен для новых пользователей |
| BR-001.4 | Смена ЖК возможна не чаще 1 раза в 30 дней |

### SLA

| Метрика | Target |
|---------|--------|
| Время авторизации | <2 сек |
| Время создания профиля | <1 сек |

---

## BP-002: Создание листинга

### Диаграмма процесса

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        BP-002: СОЗДАНИЕ ЛИСТИНГА                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐                 │
│  │ START │───►│ Загрузка │───►│ Заполне- │───►│ Валида-  │                 │
│  │       │    │ фото     │    │ ние формы│    │ ция      │                 │
│  └───────┘    └──────────┘    └──────────┘    └────┬─────┘                 │
│                                                    │                        │
│                           ┌────────────────────────┼───────────────┐        │
│                           │ valid                  │ invalid       │        │
│                           ▼                        ▼               │        │
│                     ┌───────────┐           ┌───────────┐          │        │
│                     │ Сохранение│           │ Показ     │          │        │
│                     │ листинга  │           │ ошибок    │──────────┘        │
│                     └─────┬─────┘           └───────────┘                   │
│                           │                                                 │
│                           ▼                                                 │
│                     ┌───────────┐    ┌───────────┐    ┌─────────┐          │
│                     │ Публикация│───►│ Уведомле- │───►│   END   │          │
│                     │ в каталог │    │ ние owner │    └─────────┘          │
│                     └───────────┘    └───────────┘                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Описание шагов

| Шаг | Действие | Исполнитель | Данные |
|-----|----------|-------------|--------|
| 1 | Нажимает "Добавить вещь" | Owner | - |
| 2 | Загружает фото (1-5) | Owner | images[] |
| 3 | Заполняет название | Owner | title (3-100 chars) |
| 4 | Заполняет описание | Owner | description (10-1000) |
| 5 | Выбирает категорию | Owner | category_id |
| 6 | Указывает цену/сутки | Owner | daily_price (50-50000) |
| 7 | Указывает депозит | Owner | deposit (default=2×price) |
| 8 | Нажимает "Опубликовать" | Owner | - |
| 9 | Валидирует данные | System | All fields |
| 10 | Сохраняет листинг | System | Listing record |
| 11 | Публикует в каталог ЖК | System | - |
| 12 | Отправляет уведомление | System | Push to owner |

### Валидация

| Поле | Правило |
|------|---------|
| photos | Минимум 1, максимум 5, <5MB каждое |
| title | 3-100 символов, без спецсимволов |
| description | 10-1000 символов |
| category | Из списка разрешённых |
| daily_price | 50-50000 ₽ |
| deposit | 0-100000 ₽, default = daily_price × 2 |

### Бизнес-правила

| Правило | Описание |
|---------|----------|
| BR-002.1 | Листинг привязывается к ЖК владельца |
| BR-002.2 | Листинг сразу активен (без премодерации) |
| BR-002.3 | Владелец может иметь до 20 активных листингов |
| BR-002.4 | Запрещённые категории: оружие, алкоголь, мед.изделия |

---

## BP-003: Бронирование и оплата

### Диаграмма процесса

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        BP-003: БРОНИРОВАНИЕ И ОПЛАТА                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  RENTER                    SYSTEM                      YOOKASSA             │
│  ───────                   ──────                      ────────             │
│                                                                             │
│  ┌───────┐                                                                  │
│  │ START │                                                                  │
│  └───┬───┘                                                                  │
│      │                                                                      │
│      ▼                                                                      │
│  ┌───────────┐         ┌───────────┐                                       │
│  │ Выбор дат │────────►│ Проверка  │                                       │
│  │           │         │ доступн.  │                                       │
│  └───────────┘         └─────┬─────┘                                       │
│                              │                                              │
│                    ┌─────────┼─────────┐                                   │
│                    │ available         │ not available                     │
│                    ▼                   ▼                                    │
│              ┌───────────┐       ┌───────────┐                             │
│              │ Расчёт    │       │ Ошибка    │                             │
│              │ суммы     │       │ "занято"  │                             │
│              └─────┬─────┘       └───────────┘                             │
│                    │                                                        │
│                    ▼                                                        │
│  ┌───────────┐    ┌───────────┐         ┌───────────┐                      │
│  │ Подтверж- │◄───│ Показ     │         │ Создание  │                      │
│  │ дение     │    │ расчёта   │────────►│ платежа   │─────────────┐        │
│  └───────────┘    └───────────┘         └───────────┘             │        │
│                                                                   ▼        │
│                                                            ┌───────────┐   │
│                                                            │ Payment   │   │
│                                                            │ Page      │   │
│                                                            └─────┬─────┘   │
│                                                                  │         │
│                    ┌───────────┐         ┌───────────┐          │         │
│                    │ Создание  │◄────────│ Webhook   │◄─────────┘         │
│                    │ booking   │ success │ callback  │ (success/fail)     │
│                    └─────┬─────┘         └───────────┘                     │
│                          │                                                  │
│                          ▼                                                  │
│                    ┌───────────┐    ┌───────────┐    ┌─────────┐          │
│                    │ Уведомл.  │───►│ Уведомл.  │───►│   END   │          │
│                    │ renter    │    │ owner     │    └─────────┘          │
│                    └───────────┘    └───────────┘                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Описание шагов

| Шаг | Действие | Исполнитель | Данные |
|-----|----------|-------------|--------|
| 1 | Нажимает "Забронировать" | Renter | listing_id |
| 2 | Выбирает даты (start, end) | Renter | start_date, end_date |
| 3 | Проверяет доступность | System | Existing bookings |
| 4 | Рассчитывает сумму | System | days × price + deposit |
| 5 | Показывает расчёт | System | amount, deposit, total |
| 6 | Подтверждает бронирование | Renter | - |
| 7 | Создаёт платёж в YooKassa | System | payment_id, amount |
| 8 | Перенаправляет на оплату | System | confirmation_url |
| 9 | Оплачивает | Renter | Card details |
| 10 | Получает webhook | System | payment.succeeded |
| 11 | Создаёт booking | System | Booking record |
| 12 | Уведомляет арендатора | System | Push "Оплачено" |
| 13 | Уведомляет владельца | System | Push "Новая заявка" |

### Расчёт суммы

```
total = (daily_price × days) + deposit

Пример:
  daily_price = 500₽
  days = 2
  deposit = 1000₽
  total = 500×2 + 1000 = 2000₽
```

### Бизнес-правила

| Правило | Описание |
|---------|----------|
| BR-003.1 | Минимальный срок аренды = 1 день |
| BR-003.2 | Максимальный срок аренды = 30 дней |
| BR-003.3 | Нельзя бронировать занятые даты |
| BR-003.4 | Оплата только через YooKassa |
| BR-003.5 | Booking создаётся только после успешной оплаты |
| BR-003.6 | Таймаут оплаты = 30 минут |

### SLA

| Метрика | Target |
|---------|--------|
| Время создания платежа | <3 сек |
| Время обработки webhook | <5 сек |

---

## BP-004: Подтверждение аренды

### Диаграмма процесса

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        BP-004: ПОДТВЕРЖДЕНИЕ АРЕНДЫ                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  OWNER                     SYSTEM                      RENTER               │
│  ─────                     ──────                      ──────               │
│                                                                             │
│              ┌───────────┐                                                  │
│              │ Получает  │◄───── Booking created                           │
│              │ заявку    │                                                  │
│              └─────┬─────┘                                                  │
│                    │                                                        │
│                    ▼                                                        │
│              ┌───────────┐                                                  │
│              │ Просматр. │                                                  │
│              │ детали    │                                                  │
│              └─────┬─────┘                                                  │
│                    │                                                        │
│           ┌────────┼────────┐                                              │
│           │        │        │                                              │
│           ▼        ▼        ▼                                              │
│     ┌─────────┐ ┌───────┐ ┌─────────┐                                      │
│     │Подтвер- │ │ Нет   │ │ Откло-  │                                      │
│     │ждает    │ │ ответа│ │ няет    │                                      │
│     └────┬────┘ └───┬───┘ └────┬────┘                                      │
│          │          │          │                                            │
│          │          │ 24h      │                                            │
│          │          ▼          │                                            │
│          │    ┌───────────┐    │                                            │
│          │    │ Авто-     │    │                                            │
│          │    │ отмена    │◄───┘                                            │
│          │    └─────┬─────┘                                                 │
│          │          │                                                       │
│          ▼          ▼                                                       │
│    ┌───────────┐ ┌───────────┐                                             │
│    │ Статус:   │ │ Статус:   │         ┌───────────┐                       │
│    │ confirmed │ │ cancelled │────────►│ Возврат   │                       │
│    └─────┬─────┘ └───────────┘         │ денег     │                       │
│          │                             └───────────┘                        │
│          ▼                                                                  │
│    ┌───────────┐    ┌───────────┐    ┌─────────┐                           │
│    │ Передача  │───►│ Уведомл.  │───►│   END   │                           │
│    │ контактов │    │ renter    │    └─────────┘                           │
│    └───────────┘    └───────────┘                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Описание шагов

| Шаг | Действие | Исполнитель | Данные |
|-----|----------|-------------|--------|
| 1 | Получает push о заявке | Owner | booking notification |
| 2 | Открывает заявку | Owner | booking_id |
| 3 | Просматривает детали | Owner | renter info, dates, amount |
| 4a | Подтверждает | Owner | - |
| 4b | Отклоняет + причина | Owner | rejection_reason |
| 4c | Не отвечает 24ч | System | timeout |
| 5a | Статус → confirmed | System | booking.status |
| 5b/5c | Статус → cancelled | System | booking.status |
| 6a | Передаёт контакты renter | System | owner.telegram |
| 6b/6c | Инициирует возврат | System | refund via YooKassa |
| 7 | Уведомляет стороны | System | Push notifications |

### Причины отклонения

| Код | Причина |
|-----|---------|
| OWNER_NEEDS | Вещь нужна владельцу |
| DATES_NOT_SUITABLE | Даты не подходят |
| RENTER_RATING | Низкий рейтинг арендатора |
| OTHER | Другая причина (текст) |

### Бизнес-правила

| Правило | Описание |
|---------|----------|
| BR-004.1 | Таймаут на ответ = 24 часа |
| BR-004.2 | При отклонении/таймауте — полный возврат |
| BR-004.3 | После подтверждения renter получает telegram owner |
| BR-004.4 | Владелец видит рейтинг и историю арендатора |

---

## BP-005: Процесс аренды

### Диаграмма процесса

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        BP-005: ПРОЦЕСС АРЕНДЫ                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  RENTER              OWNER                SYSTEM                            │
│  ──────              ─────                ──────                            │
│                                                                             │
│  ┌───────────┐                                                              │
│  │ Пишет в   │──────────────────────────►                                  │
│  │ Telegram  │                                                              │
│  └───────────┘       ┌───────────┐                                         │
│                      │ Отвечает, │◄────────                                │
│                      │ договарив.│                                          │
│                      └─────┬─────┘                                          │
│                            │                                                │
│                            ▼                                                │
│  ┌───────────┐       ┌───────────┐                                         │
│  │ Приходит  │◄──────│ Передаёт  │                                         │
│  │ за вещью  │       │ вещь      │                                         │
│  └─────┬─────┘       └───────────┘                                         │
│        │                                                                    │
│        ▼                                                                    │
│  ┌───────────┐                          ┌───────────┐                      │
│  │Использует │                          │ Статус:   │                      │
│  │ вещь      │─────────────────────────►│ in_progr. │                      │
│  └─────┬─────┘                          └───────────┘                      │
│        │                                       │                            │
│        │ (день возврата)                       ▼                            │
│        │                                ┌───────────┐                       │
│        │                                │ Напомина- │───────────────┐       │
│        │                                │ ние       │               │       │
│        │                                └───────────┘               ▼       │
│        │                                                      ┌─────────┐  │
│        │                                                      │ Push    │  │
│        │                                                      │ renter  │  │
│        │                                                      └─────────┘  │
│        ▼                                                                    │
│  ┌───────────┐       ┌───────────┐                                         │
│  │ Возвращает│──────►│ Принимает │                                         │
│  │ вещь      │       │ вещь      │                                         │
│  └───────────┘       └─────┬─────┘                                         │
│                            │                                                │
│                            ▼                                                │
│                      ┌─────────┐                                            │
│                      │   END   │ → BP-006                                  │
│                      └─────────┘                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Описание шагов

| Шаг | Действие | Исполнитель | Данные |
|-----|----------|-------------|--------|
| 1 | Пишет владельцу в Telegram | Renter | - |
| 2 | Договариваются о месте/времени | Both | - |
| 3 | Передаёт вещь | Owner → Renter | - |
| 4 | В start_date статус → in_progress | System | booking.status |
| 5 | Использует вещь | Renter | - |
| 6 | Напоминание о возврате | System | Push (день возврата, 10:00) |
| 7 | Возвращает вещь | Renter → Owner | - |

### Бизнес-правила

| Правило | Описание |
|---------|----------|
| BR-005.1 | Статус in_progress автоматически в start_date |
| BR-005.2 | Напоминание renter за 4 часа до конца |
| BR-005.3 | Если не возвращено — напоминание каждые 4 часа |
| BR-005.4 | Через 48ч просрочки — эскалация, начисление штрафа |

---

## BP-006: Завершение аренды

### Диаграмма процесса

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        BP-006: ЗАВЕРШЕНИЕ АРЕНДЫ                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  OWNER                     SYSTEM                      YOOKASSA             │
│  ─────                     ──────                      ────────             │
│                                                                             │
│  ┌───────────┐                                                              │
│  │ Нажимает  │                                                              │
│  │ "Вещь     │                                                              │
│  │ возвращ." │                                                              │
│  └─────┬─────┘                                                              │
│        │                                                                    │
│        ▼                                                                    │
│  ┌───────────┐                                                              │
│  │ Выбирает  │                                                              │
│  │ состояние │                                                              │
│  └─────┬─────┘                                                              │
│        │                                                                    │
│   ┌────┴────┐                                                              │
│   │         │                                                              │
│   ▼         ▼                                                              │
│ ┌─────┐  ┌─────────┐                                                       │
│ │ OK  │  │ Damage  │────────────────────────────► BP-007                   │
│ └──┬──┘  └─────────┘                                                       │
│    │                                                                        │
│    ▼                                                                        │
│              ┌───────────┐                                                  │
│              │ Статус:   │                                                  │
│              │ completed │                                                  │
│              └─────┬─────┘                                                  │
│                    │                                                        │
│         ┌─────────┴─────────┐                                              │
│         ▼                   ▼                                              │
│   ┌───────────┐       ┌───────────┐         ┌───────────┐                  │
│   │ Возврат   │       │ Выплата   │────────►│ Payout    │                  │
│   │ депозита  │       │ owner     │         │ API       │                  │
│   │ renter    │       │           │         └───────────┘                  │
│   └─────┬─────┘       └─────┬─────┘                                        │
│         │                   │                                               │
│         └─────────┬─────────┘                                              │
│                   ▼                                                         │
│             ┌───────────┐                                                   │
│             │ Запрос    │                                                   │
│             │ отзывов   │                                                   │
│             └─────┬─────┘                                                   │
│                   │                                                         │
│                   ▼                                                         │
│             ┌─────────┐                                                     │
│             │   END   │                                                     │
│             └─────────┘                                                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Описание шагов

| Шаг | Действие | Исполнитель | Данные |
|-----|----------|-------------|--------|
| 1 | Нажимает "Вещь возвращена" | Owner | - |
| 2 | Выбирает состояние | Owner | OK / Damage |
| 3a | Если OK: статус → completed | System | booking.status |
| 3b | Если Damage: → BP-007 (Спор) | System | - |
| 4 | Возврат депозита renter | System → YooKassa | refund (deposit) |
| 5 | Выплата owner (аренда - комиссия) | System → YooKassa | payout |
| 6 | Запрос отзывов обеим сторонам | System | Push |

### Расчёт выплат

```
При успешном завершении:

Renter получает:
  + deposit (возврат)

Owner получает:
  + rental_amount - commission
  = daily_price × days × (1 - take_rate)
  = 500 × 2 × (1 - 0.125)
  = 875₽

Платформа получает:
  + rental_amount × take_rate
  = 1000 × 0.125
  = 125₽
```

### Бизнес-правила

| Правило | Описание |
|---------|----------|
| BR-006.1 | Только owner может завершить аренду |
| BR-006.2 | При OK — автоматические выплаты |
| BR-006.3 | При Damage — эскалация в спор |
| BR-006.4 | Выплата owner в течение T+1 |
| BR-006.5 | Возврат депозита мгновенный |

---

## BP-007: Разрешение споров

### Диаграмма процесса

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        BP-007: РАЗРЕШЕНИЕ СПОРОВ                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  INITIATOR           RESPONDENT           ADMIN              SYSTEM         │
│  ─────────           ──────────           ─────              ──────         │
│                                                                             │
│  ┌───────────┐                                                              │
│  │ Открывает │                                                              │
│  │ спор      │                                                              │
│  └─────┬─────┘                                                              │
│        │                                                                    │
│        ▼                                                                    │
│  ┌───────────┐                                          ┌───────────┐      │
│  │ Описание  │─────────────────────────────────────────►│ Создание  │      │
│  │ + фото    │                                          │ dispute   │      │
│  └───────────┘                                          └─────┬─────┘      │
│                                                               │            │
│                      ┌───────────┐                            │            │
│                      │ Уведомл.  │◄───────────────────────────┘            │
│                      │ respondent│                                          │
│                      └─────┬─────┘                                          │
│                            │                                                │
│                            ▼                                                │
│                      ┌───────────┐                                          │
│                      │ Ответ +   │                                          │
│                      │ доказат.  │                                          │
│                      └─────┬─────┘                                          │
│                            │                                                │
│                            │ 24h timeout                                    │
│                            ▼                                                │
│                                           ┌───────────┐                     │
│                                           │ Рассмотр. │                     │
│                                           │ спора     │                     │
│                                           └─────┬─────┘                     │
│                                                 │                           │
│                              ┌──────────────────┼──────────────────┐        │
│                              │                  │                  │        │
│                              ▼                  ▼                  ▼        │
│                        ┌─────────┐        ┌─────────┐        ┌─────────┐   │
│                        │ Owner   │        │ Split   │        │ Renter  │   │
│                        │ wins    │        │ 50/50   │        │ wins    │   │
│                        └────┬────┘        └────┬────┘        └────┬────┘   │
│                             │                  │                  │        │
│                             └──────────────────┼──────────────────┘        │
│                                                │                            │
│                                                ▼                            │
│                                          ┌───────────┐                      │
│                                          │ Распредел.│                      │
│                                          │ депозита  │                      │
│                                          └─────┬─────┘                      │
│                                                │                            │
│                                                ▼                            │
│                                          ┌─────────┐                        │
│                                          │   END   │                        │
│                                          └─────────┘                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Описание шагов

| Шаг | Действие | Исполнитель | Данные |
|-----|----------|-------------|--------|
| 1 | Открывает спор | Initiator | dispute_type |
| 2 | Описывает проблему + фото | Initiator | description, photos[] |
| 3 | Создаёт dispute | System | Dispute record |
| 4 | Уведомляет вторую сторону | System | Push |
| 5 | Вторая сторона отвечает | Respondent | response, evidence |
| 6 | Админ рассматривает | Admin | - |
| 7 | Выносит решение | Admin | resolution_type, amounts |
| 8 | Распределяет депозит | System | Payouts |

### Типы решений

| Решение | Депозит → Owner | Депозит → Renter |
|---------|-----------------|------------------|
| Owner wins | 100% | 0% |
| Split 50/50 | 50% | 50% |
| Renter wins | 0% | 100% |
| Custom | X% | (100-X)% |

### Бизнес-правила

| Правило | Описание |
|---------|----------|
| BR-007.1 | Спор можно открыть в течение 48ч после возврата |
| BR-007.2 | Ответ второй стороне — 24ч |
| BR-007.3 | Если нет ответа — решение без ответчика |
| BR-007.4 | Админ решает в течение 48ч |
| BR-007.5 | Решение финальное, обжалованию не подлежит |

---

## BP-008: Выплата владельцу

### Диаграмма процесса

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        BP-008: ВЫПЛАТА ВЛАДЕЛЬЦУ                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  SYSTEM                           YOOKASSA                   OWNER          │
│  ──────                           ────────                   ─────          │
│                                                                             │
│  ┌───────────┐                                                              │
│  │ Аренда    │                                                              │
│  │ завершена │                                                              │
│  │ (OK)      │                                                              │
│  └─────┬─────┘                                                              │
│        │                                                                    │
│        ▼                                                                    │
│  ┌───────────┐                                                              │
│  │ Расчёт    │                                                              │
│  │ суммы     │                                                              │
│  │ выплаты   │                                                              │
│  └─────┬─────┘                                                              │
│        │                                                                    │
│        │ amount = rental × (1 - commission)                                │
│        ▼                                                                    │
│  ┌───────────┐                                                              │
│  │ Проверка  │                                                              │
│  │ реквизитов│                                                              │
│  └─────┬─────┘                                                              │
│        │                                                                    │
│   ┌────┴────┐                                                              │
│   │         │                                                              │
│   ▼ нет     ▼ есть                                                         │
│ ┌─────┐  ┌───────────┐         ┌───────────┐                               │
│ │Запрос│  │ Создание  │────────►│ Payout    │                               │
│ │рекви-│  │ payout    │         │ API       │                               │
│ │зитов │  └───────────┘         └─────┬─────┘                               │
│ └──┬──┘                               │                                     │
│    │                                  │                                     │
│    │                         ┌────────┼────────┐                            │
│    │                         │ success        │ failed                     │
│    │                         ▼                ▼                             │
│    │                   ┌───────────┐    ┌───────────┐                       │
│    │                   │ Баланс    │    │ Retry     │                       │
│    │                   │ обновлён  │    │ (3 раза)  │                       │
│    │                   └─────┬─────┘    └───────────┘                       │
│    │                         │                                              │
│    │                         ▼                                              │
│    │                   ┌───────────┐         ┌───────────┐                  │
│    └──────────────────►│ Уведомл.  │────────►│   END     │                  │
│                        │ owner     │         └───────────┘                  │
│                        └───────────┘                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Описание шагов

| Шаг | Действие | Исполнитель | Данные |
|-----|----------|-------------|--------|
| 1 | Триггер: аренда завершена OK | System | booking.status = completed |
| 2 | Расчёт суммы выплаты | System | rental × (1 - commission) |
| 3 | Проверка реквизитов owner | System | owner.payout_account |
| 4a | Если нет — запрос реквизитов | System → Owner | Push |
| 4b | Если есть — создание payout | System → YooKassa | payout request |
| 5 | Выполнение payout | YooKassa | bank transfer |
| 6 | Обновление баланса | System | owner.balance |
| 7 | Уведомление owner | System | Push "Получено X₽" |

### Бизнес-правила

| Правило | Описание |
|---------|----------|
| BR-008.1 | Выплата в течение T+1 (следующий рабочий день) |
| BR-008.2 | Минимальная сумма вывода = 100₽ |
| BR-008.3 | Комиссия за вывод: 0% (платит платформа) |
| BR-008.4 | При ошибке — 3 retry, затем manual |
| BR-008.5 | Реквизиты: карта РФ банка |

---

## Сводная таблица процессов

| Процесс | Триггер | Результат | SLA |
|---------|---------|-----------|-----|
| BP-001 | Открытие WebApp | Профиль создан | <5 сек |
| BP-002 | Клик "Добавить" | Листинг в каталоге | <1 мин |
| BP-003 | Клик "Забронировать" | Booking создан | <3 мин |
| BP-004 | Booking создан | Confirmed/Cancelled | <24ч |
| BP-005 | Confirmed | In progress | Auto |
| BP-006 | Клик "Вещь возвращена" | Completed/Dispute | <1 мин |
| BP-007 | Открытие спора | Resolved | <72ч |
| BP-008 | Completed | Payout done | T+1 |

---

*Документ создан: Business-Analyst Agent | Дата: 2025-02-05*
